<?php

declare(strict_types=1);

namespace Tests\BitBag\SyliusMolliePlugin\PHPUnit\Functional\Api;

use BitBag\SyliusMolliePlugin\Client\MollieApiClient;
use Doctrine\ORM\EntityManagerInterface;
use Payum\Core\Model\Identity;
use Sylius\Component\Core\Model\Payment;
use Sylius\Component\Core\Model\PaymentInterface;
use Sylius\Component\Core\Repository\PaymentRepositoryInterface;
use Sylius\Component\Resource\Repository\RepositoryInterface;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Tests\BitBag\SyliusMolliePlugin\PHPUnit\Functional\FunctionalTestCase;

final class RefundOrderWebhookTest extends FunctionalTestCase
{
    /** @var MollieApiClient */
    private $mollieApiClient;

    /** @var RepositoryInterface */
    private $securityTokenRepository;

    /** @var PaymentRepositoryInterface */
    private $paymentRepository;

    /** @var EntityManagerInterface */
    private $entityManager;

    public function setUp(): void
    {
        parent::setUp(); // TODO: Change the autogenerated stub

        $this->mollieApiClient = self::getContainer()->get('bitbag_sylius_mollie_plugin.mollie_api_client');
        $this->mollieApiClient->setApiEndpoint('http://localhost:8217');
        $this->securityTokenRepository = self::getContainer()->get('sylius.repository.payment_security_token');
        $this->paymentRepository = self::getContainer()->get('sylius.repository.payment');
        $this->entityManager = self::getContainer()->get('doctrine.orm.entity_manager');
    }

    public function test_order_status_after_refund_with_credit_memos(): void
    {
        $fixtures = $this->loadFixturesFromFiles([
            'Api/RefundOrderWebhookTest/test_order_status_after_refund_with_credit_memos.yaml'
        ]);

        /** @var PaymentInterface $payment */
        $payment = $fixtures['order_payment'];
        $paymentId = $payment->getId();

        $notifyToken = $this->securityTokenRepository->findOneBy(['hash' => $fixtures['notify_token']->getHash()]);
        $refundToken = $this->securityTokenRepository->findOneBy(['hash' => $fixtures['refund_token']->getHash()]);
        $notifyToken->setDetails(new Identity($paymentId, Payment::class));
        $refundToken->setDetails(new Identity($paymentId, Payment::class));

        $payment = $this->paymentRepository->find($paymentId);

        $details = $payment->getDetails();
        $details['order_mollie_id'] = 'ord_' . $fixtures['order']->getId() . '-' . $fixtures['order_item']->getId();
        $payment->setDetails($details);

        $this->entityManager->flush();

        $this->request(
            Request::METHOD_POST,
            '/payment/notify/654fed',
            [],
            '',
            ['id' => 'ord_' . $fixtures['order']->getId() . '-' . $fixtures['order_item']->getId()]
        );

        $response = $this->client->getResponse();

        die(var_dump($response->getContent()));

        $this->assertEquals(Response::HTTP_OK, $response->getStatusCode());
    }

    private function request(
        string $method,
        string $uri,
        array $server = [],
        string $requestBody = null,
        array $parameters = [],
        array $files = []
    ): void {
        $this->client->request($method, $uri, $parameters, $files, $server, $requestBody);
    }
}
